<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理员登录 - 导航系统</title>
    
    <!-- Vue 2 -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
    
    <!-- Element UI CSS -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    
    <!-- Element UI JavaScript -->
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Microsoft YaHei', Arial, sans-serif;
        }
        
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 40px;
            width: 100%;
            max-width: 400px;
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .login-header h1 {
            margin: 0 0 8px 0;
            font-size: 28px;
            font-weight: 600;
            color: #303133;
        }
        
        .login-header p {
            margin: 0;
            color: #909399;
            font-size: 14px;
        }
        
        .login-form {
            margin-top: 32px;
        }
        
        .form-item {
            margin-bottom: 24px;
        }
        
        .login-button {
            width: 100%;
            height: 48px;
            font-size: 16px;
            font-weight: 500;
        }
        
        .remember-me {
            margin: 16px 0;
        }
        
        .login-footer {
            text-align: center;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid #ebeef5;
            color: #909399;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="login-container">
            <div class="login-card">
                <div class="login-header">
                    <h1>
                        <i class="el-icon-setting" style="color: #667eea; margin-right: 8px;"></i>
                        管理系统
                    </h1>
                    <p>
                        <i class="el-icon-key" style="color: #909399; margin-right: 4px;"></i>
                        管理员登录，请输入您的凭据
                    </p>
                </div>
                
                <el-form 
                    ref="loginForm"
                    :model="form" 
                    :rules="rules"
                    class="login-form"
                    @submit.native.prevent="handleLogin"
                >
                    <el-form-item prop="username" class="form-item">
                        <el-input
                            v-model="form.username"
                            placeholder="请输入管理员用户名"
                            size="medium"
                            prefix-icon="el-icon-user"
                            clearable
                        />
                    </el-form-item>
                    
                    <el-form-item prop="password" class="form-item">
                        <el-input
                            v-model="form.password"
                            type="password"
                            placeholder="请输入密码"
                            size="medium"
                            prefix-icon="el-icon-lock"
                            show-password
                            clearable
                            @keyup.enter.native="handleLogin"
                        />
                    </el-form-item>
                    
                    <div class="remember-me">
                        <el-checkbox v-model="form.rememberMe">
                            记住我
                        </el-checkbox>
                    </div>
                    
                    <el-button 
                        type="primary" 
                        class="login-button"
                        :loading="loading"
                        @click="handleLogin"
                    >
                        <i v-if="!loading" class="el-icon-right"></i>
                        {{ loading ? '登录中...' : '登录管理系统' }}
                    </el-button>
                </el-form>
                
                <div class="login-footer">
                    <p>导航系统管理后台 v2.0</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        new Vue({
            el: '#app',
            data() {
                return {
                    loading: false,
                    form: {
                        username: '',
                        password: '',
                        rememberMe: false
                    },
                    rules: {
                        username: [
                            { required: true, message: '请输入用户名', trigger: 'blur' },
                            { min: 3, max: 20, message: '用户名长度在 3 到 20 个字符', trigger: 'blur' },
                            { pattern: /^[a-zA-Z0-9_]+$/, message: '用户名只能包含字母、数字和下划线', trigger: 'blur' }
                        ],
                        password: [
                            { required: true, message: '请输入密码', trigger: 'blur' },
                            { min: 6, max: 50, message: '密码长度在 6 到 50 个字符', trigger: 'blur' }
                        ]
                    },
                    // 修改这里：动态获取当前域名
                    apiBaseUrl: window.location.protocol + '//' + window.location.hostname + ':5000/api'
                }
            },
            mounted() {
                this.checkLoginStatus();
            },
            methods: {
                // 处理登录
                async handleLogin() {
                    try {
                        const valid = await this.$refs.loginForm.validate();
                        if (!valid) return;
                        
                        this.loading = true;
                        
                        const response = await fetch(`${this.apiBaseUrl}/auth/login`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                username: this.form.username,
                                password: this.form.password,
                                remember_me: this.form.rememberMe
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (result.code === 1) {
                            this.handleLoginSuccess(result.data);
                        } else {
                            this.$message.error(result.msg || '登录失败，请检查用户名和密码');
                        }
                        
                    } catch (error) {
                        console.error('登录请求失败:', error);
                        this.$message.error('网络连接失败，请检查后端服务是否启动');
                    } finally {
                        this.loading = false;
                    }
                },
                
                // 处理登录成功
                async handleLoginSuccess(data) {
                    try {
                        const actualToken = data.token.access_token;
                        
                        // 保存token和用户信息
                        localStorage.setItem('admin_token', actualToken);
                        localStorage.setItem('admin_user', JSON.stringify(data.user));
                        
                        // 处理记住用户名
                        if (this.form.rememberMe) {
                            localStorage.setItem('admin_remembered_username', this.form.username);
                        } else {
                            localStorage.removeItem('admin_remembered_username');
                        }
                        
                        console.log('Token已保存:', actualToken.substring(0, 20) + '...');
                        
                        // 验证token有效性
                        const isTokenValid = await this.verifyToken(actualToken);
                        
                        if (isTokenValid) {
                            this.$message.success('登录成功，正在跳转...');
                            setTimeout(() => {
                                window.location.href = './dashboard.html';
                            }, 1000);
                        } else {
                            localStorage.removeItem('admin_token');
                            localStorage.removeItem('admin_user');
                            this.$message.error('登录验证失败，请重试');
                        }
                        
                    } catch (error) {
                        console.error('处理登录成功时出错:', error);
                        this.$message.error('登录处理失败，请重试');
                    }
                },
                
                // 验证token有效性
                async verifyToken(token) {
                    try {
                        console.log('正在验证token有效性...');
                        
                        // 优先使用 /user/profile
                        const response = await fetch(`${this.apiBaseUrl}/user/profile`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        if (response.ok) {
                            const result = await response.json();
                            console.log('Token验证结果(profile):', result);
                            if (result.code === 1) return true;
                        }

                        // 回退到 /auth/verify
                        const resp2 = await fetch(`${this.apiBaseUrl}/auth/verify`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (!resp2.ok) return false;
                        
                        const vr = await resp2.json();
                        console.log('Token验证结果(verify):', vr);
                        return vr && vr.code === 1;
                        
                    } catch (error) {
                        console.error('Token验证异常:', error);
                        return false;
                    }
                },
                
                // 加载记住的用户名
                loadRememberedUsername() {
                    const rememberedUsername = localStorage.getItem('admin_remembered_username');
                    if (rememberedUsername) {
                        this.form.username = rememberedUsername;
                        this.form.rememberMe = true;
                    }
                },
                
                // 检查登录状态
                async checkLoginStatus() {
                    const token = localStorage.getItem('admin_token');
                    if (token) {
                        console.log('发现已存在的token，正在验证...');
                        
                        try {
                            const isValid = await this.verifyToken(token);
                            if (isValid) {
                                window.location.href = './dashboard.html';
                                return;
                            }
                        } catch (error) {
                            console.warn('验证token时发生异常：', error);
                        }
                        
                        console.log('已存在token无效，清除并显示登录页面');
                        localStorage.removeItem('admin_token');
                        localStorage.removeItem('admin_user');
                    }
                    
                    // 加载记住的用户名
                    this.loadRememberedUsername();
                }
            }
        });
    </script>
</body>
</html>