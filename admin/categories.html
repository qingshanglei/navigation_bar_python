<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>分类管理</title>
    
    <!-- Vue 2 -->
    <script src="https://unpkg.com/vue@2"></script>
    
    <!-- Element UI CSS -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    
    <!-- Element UI JavaScript -->
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <style>
      body, html { 
        height: 100%; 
        margin: 0; 
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: #fef7f0;
      }
      .layout { 
        min-height: 100vh; 
        padding: 16px; 
      }
      .page-card {
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        padding: 20px;
        height: calc(100vh - 80px);
        display: flex;
        flex-direction: column;
      }
      .toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
        margin-bottom: 16px;
        flex-shrink: 0;
      }
      .toolbar .spacer { flex: 1; }
      .search-area { 
        display: flex; 
        gap: 12px; 
        flex-wrap: wrap;
        align-items: center;
      }
      .table-wrap {
        flex: 1;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }
      .el-table {
        flex: 1;
        border-radius: 8px;
        overflow: hidden;
      }
      .el-table th {
        background: #fef7f0;
        font-weight: 600;
        color: #374151;
      }
      .name-cell { 
        display: flex; 
        align-items: center; 
        gap: 8px; 
      }
      .footer { 
        margin-top: 16px; 
        display: flex; 
        justify-content: flex-end;
        flex-shrink: 0;
      }
      .level-indent { padding-left: 20px; }
      
      /* 响应式优化 */
      @media (max-width: 768px) {
        .layout {
          padding: 8px;
        }
        .page-card {
          padding: 12px;
          height: calc(100vh - 40px);
        }
        .search-area {
          flex-direction: column;
          align-items: stretch;
        }
        .search-area .el-input,
        .search-area .el-select {
          width: 100% !important;
        }
        .toolbar {
          flex-direction: column;
          align-items: stretch;
        }
      }
    </style>
  </head>
  <body>
    <div id="app" class="layout">
      <div class="page-card">
        <div class="toolbar">
          <div class="search-area">
           
            <el-input v-model="filters.keyword" placeholder="搜索名称/描述" clearable style="width:220px"></el-input>
            <el-select v-model="filters.level" placeholder="层级" clearable  style="width:120px">
              <el-option :value="1" label="一级"></el-option>
              <el-option :value="2" label="二级"></el-option>
              <el-option :value="3" label="三级"></el-option>
            </el-select>
            <el-select v-model="filters.is_public" placeholder="公开状态" clearable style="width:140px">
              <el-option :value="1" label="公开"></el-option>
              <el-option :value="0" label="私有"></el-option>
            </el-select>
            <el-select v-model="filters.sort" placeholder="排序字段" clearable style="width:160px">
              <el-option value="sort_order" label="排序优先级"></el-option>
              <el-option value="created_at" label="创建时间"></el-option>
            </el-select>
            <el-button type="primary" icon="el-icon-search" @click="reload">查询</el-button>
            <el-button icon="el-icon-refresh" @click="resetFilters">重置</el-button>
          </div>
          <div class="spacer"></div>
        </div>

        <div class="table-wrap">
          <el-table 
            :data="list" 
            v-loading="loading" 
            size="small" 
            border
            row-key="id"
            lazy
            :load="loadChildren"
            :tree-props="{children: 'children', hasChildren: 'hasChildren'}"
          >
            <el-table-column type="index" width="50"  ></el-table-column>
            <el-table-column prop="id" label="ID" width="70" sortable  align="center" ></el-table-column>
            <el-table-column label="名称" min-width="180">
              <template slot-scope="scope">
                <div class="name-cell">
                  <strong>{{ scope.row.name }}</strong>
                </div>
              </template>
            </el-table-column>
            <el-table-column label="分类描述" min-width="220">
              <template slot-scope="scope">
                <span v-if="scope.row.description" class="el-text--small">{{ scope.row.description }}</span>
                <span v-else class="el-text--small" style="color:#909399">-</span>
              </template>
            </el-table-column>
            <el-table-column prop="sort_order" label="排序优先级" sortable  width="110" align="center"  ></el-table-column>
            <el-table-column prop="level" label="分类层级" sortable  width="100" align="center">
              <template slot-scope="scope">
                <el-tag size="small" :type="scope.row.level === 1 ? 'primary' : scope.row.level === 2 ? 'success' : 'warning'">
                  {{ scope.row.level }}级
                </el-tag>
              </template>
            </el-table-column>
            <el-table-column label="是否公开" width="80" align="center">
              <template slot-scope="scope">
                <el-tag :type="scope.row.is_public ? 'success' : 'info'" size="small">
                  {{ scope.row.is_public ? '公开' : '私有' }}
                </el-tag>
              </template>
            </el-table-column>
            <el-table-column prop="created_at" label="创建时间" width="160" align="center"  ></el-table-column>
            <el-table-column label="功能" width="300" fixed="right" align="center">
              <template slot-scope="scope">
                <el-button size="small" icon="el-icon-plus" type="primary" @click="openCreate(scope.row)">新建分类</el-button>
                <el-button size="small" type="primary" @click="openEdit(scope.row)">编辑</el-button>
                <el-button size="small" type="danger" @click="handleDelete(scope.row)">删除</el-button>
              </template>
            </el-table-column>
          </el-table>
        </div>

        <div class="footer">
          <el-pagination
            :current-page.sync="pagination.page"
            :page-size.sync="pagination.size"
            :page-sizes="[10, 20, 50, 100]"
            :total="pagination.total"
            layout="total, sizes, prev, pager, next, jumper"
            @size-change="reload"
            @current-change="reload"
          ></el-pagination>
        </div>
      </div>

      <!-- 新建/编辑对话框 -->
      <el-dialog
        :title="dialogMode === 'create' ? '新建分类' : '编辑分类'"
        :visible.sync="dialogVisible"
        width="500px"
        @close="resetForm"
      >
        <el-form
          ref="formRef"
          :model="form"
          :rules="formRules"
          label-width="100px"
        >
          <el-form-item label="分类名称" prop="name">
            <el-input v-model="form.name" placeholder="请输入分类名称"></el-input>
          </el-form-item>
          <el-form-item label="父分类" prop="parent_id">
            <el-select v-model="form.parent_id" placeholder="选择父分类（留空为顶级）" clearable style="width:100%">
              <el-option :value="null" label="顶级分类">顶级分类</el-option>
              <el-option 
                v-for="item in parentOptions" 
                :key="item.id" 
                :value="item.id" 
                :label="item.name"
                :disabled="isParentDisabled(item.id)"
              >{{ item.name }}</el-option>
            </el-select>
          </el-form-item>
          <el-form-item label="分类描述" prop="description">
            <el-input v-model="form.description" type="textarea" :rows="3" placeholder="请输入分类描述"></el-input>
          </el-form-item>
          <el-form-item label="排序优先级" prop="sort_order">
            <el-input-number v-model="form.sort_order" :min="0" :max="999" style="width:100%"></el-input-number>
          </el-form-item>
          <el-form-item label="公开状态">
            <el-switch v-model="form.is_public" :active-value="1" :inactive-value="0"></el-switch>
          </el-form-item>
        </el-form>
        <span slot="footer" class="dialog-footer">
          <el-button @click="dialogVisible = false">取消</el-button>
          <el-button type="primary" :loading="submitting" @click="handleSubmit">
            {{ dialogMode === 'create' ? '创建' : '更新' }}
          </el-button>
        </span>
      </el-dialog>
  </div>
  <script>
    const apiBaseUrl = 'http://localhost:5000';
    new Vue({
      el: '#app',
      data() {
        return {
          loading: false,
          submitting: false,
          dialogVisible: false,
          dialogMode: 'create',
          list: [],
          parentOptions: [],
          pagination: { page: 1, size: 10, total: 0 },
          filters: { keyword: '', level: null, is_public: null, sort: 'sort_order' },
          form: { id: null, name: '', parent_id: null, description: '', sort_order: 0, is_public: 1 },
          formRules: { name: [{ required: true, message: '请输入分类名称', trigger: 'blur' }] }
        };
      },
      methods: {
        // 获取认证请求头：兼容多存储与键名，自动补齐 Bearer 前缀
        getAuthHeaders() {
          // 兼容多种存储与键名
          const tryGet = (store, keys) => {
            for (const k of keys) {
              const v = store.getItem(k);
              if (v) return v;
            }
            return null;
          };
          const keys = ['token', 'Authorization', 'authorization', 'authToken', 'auth_token', 'admin_token'];
          let token = tryGet(localStorage, keys) || tryGet(sessionStorage, keys);

          // 尝试从 URL 参数获取（仅用于调试/临时登录传参）
          if (!token && location && location.search) {
            const sp = new URLSearchParams(location.search);
            token = sp.get('token') || sp.get('auth') || sp.get('Authorization');
          }

          if (!token) {
            this.$message.error('未登录或登录已过期');
            return null;
          }

          // 处理 JSON 包装或带引号的情况
          try {
            if (token.trim().startsWith('{')) {
              const obj = JSON.parse(token);
              token = obj.token || obj.access_token || token;
            }
          } catch (e) {
            // ignore JSON parse error
          }
          token = (token || '').toString().replace(/^"|"$/g, '').trim();

          // 自动补齐 Bearer 前缀
          const auth = /^Bearer\s+/i.test(token) ? token : `Bearer ${token}`;
          return { 'Content-Type': 'application/json', 'Authorization': auth };
        },
        // 加载分类列表：根据筛选条件与分页从后端获取数据
        async loadList() {
          this.loading = true;
          try {
            const headers = this.getAuthHeaders();
            if (!headers) return;
            const params = { page: this.pagination.page, size: this.pagination.size };
            if (this.filters.level) params.level = this.filters.level;
            if (this.filters.is_public !== null) params.is_public = this.filters.is_public;
            if (this.filters.sort) params.sort = this.filters.sort;
            if (this.filters.keyword) params.keyword = this.filters.keyword;
            const resp = await axios.get(`${apiBaseUrl}/admin/categories`, { headers, params });
            console.log("======加载分类列表========resp");
            console.log(resp);
            const result = resp.data;
            if (result.code === 1 && result.data && result.data.length > 0) {
              const data = result.data[0];
              this.list = (data.list || []).map(it => ({ ...it, hasChildren: it.level < 3 }));
              this.pagination.total = data.pagination ? data.pagination.total : 0;
            } else {
              this.list = [];
              this.pagination.total = 0;
            }
          } catch (e) {
            console.error('加载分类列表失败:', e);
            this.$message.error('加载分类列表失败: ' + e.message);
          } finally {
            this.loading = false;
          }
        },
        // 懒加载子分类：表格树展开时按父ID加载子节点
        async loadChildren(tree, treeNode, resolve) {
          try {
            const headers = this.getAuthHeaders();
            if (!headers) return resolve([]);
            const resp = await axios.get(`${apiBaseUrl}/admin/categories`, { headers, params: { parent_id: tree.id } });
            console.log("========headers======resp");
            console.log(resp);
            const result = resp.data;
            if (result.code === 1 && result.data && result.data.length > 0) {
              const children = (result.data[0].list || []).map(it => ({ ...it, hasChildren: it.level < 3 }));
              resolve(children);
            } else {
              resolve([]);
            }
          } catch (e) {
            console.error('加载子分类失败:', e);
            resolve([]);
          }
        },
        // 加载父分类下拉选项：获取顶级分类列表
        async loadParentOptions() {
          try {
            const headers = this.getAuthHeaders();
            if (!headers) return;
            const resp = await axios.get(`${apiBaseUrl}/admin/categories/categoriesRoot`, { headers });
            console.log("======加载父分类下拉选项：获取顶级分类列表========resp");
            console.log(resp);
            const result = resp.data;
            if (result.code === 1 && Array.isArray(result.data)) {
              this.parentOptions = result.data;
            } else {
              this.parentOptions = [];
            }
          } catch (e) {
            console.error('加载父分类选项失败:', e);
            this.parentOptions = [];
          }
        },
        // 判断父分类是否禁用：编辑时禁止选择自身（可扩展为禁止自身及后代）
        isParentDisabled(parentId) {
          if (this.dialogMode === 'create') return false;
          return parentId === this.form.id;
        },
        // 重置筛选条件并刷新列表
        resetFilters() {
          this.filters.keyword = '';
          this.filters.level = null;
          this.filters.is_public = null;
          this.filters.sort = 'sort_order';
          this.pagination.page = 1;
          this.reload();
        },
        // 重新加载列表数据
        reload() { this.loadList(); },
        // 打开新建对话框：可从行操作默认带入父分类
        openCreate(row) {
          this.dialogMode = 'create';
          this.resetForm();
          if (row && row.id) this.form.parent_id = row.id;
          this.loadParentOptions();
          this.dialogVisible = true;
        },
        // 打开编辑对话框：填充当前行数据
        openEdit(row) {
          this.dialogMode = 'edit';
          this.form.id = row.id;
          this.form.name = row.name;
          this.form.parent_id = row.parent_id;
          this.form.description = row.description || '';
          this.form.sort_order = row.sort_order || 0;
          this.form.is_public = row.is_public;
          this.loadParentOptions();
          this.dialogVisible = true;
        },
        // 重置表单：恢复为初始状态并清理校验
        resetForm() {
          this.form = { id: null, name: '', parent_id: null, description: '', sort_order: 0, is_public: 1 };
          if (this.$refs.formRef) this.$refs.formRef.resetFields();
        },
        // 提交表单：区分创建/更新，成功后刷新列表
        async handleSubmit() {
          if (!this.$refs.formRef) return;
          try { await this.$refs.formRef.validate(); } catch (e) { return; }
          this.submitting = true;
          try {
            const headers = this.getAuthHeaders();
            if (!headers) return;
            const payload = { name: this.form.name, parent_id: this.form.parent_id, description: this.form.description, sort_order: this.form.sort_order, is_public: this.form.is_public };
            let resp;
            if (this.dialogMode === 'create') {
              resp = await axios.post(`${apiBaseUrl}/admin/categories`, payload, { headers });
            } else {
              resp = await axios.put(`${apiBaseUrl}/admin/categories/${this.form.id}`, payload, { headers });
            }
            const result = resp.data;
            if (result.code === 1) {
              this.$message.success(this.dialogMode === 'create' ? '创建成功' : '更新成功');
              this.dialogVisible = false;
              this.reload();
            } else {
              this.$message.error(result.msg || '操作失败');
            }
          } catch (e) {
            console.error('提交失败:', e);
            this.$message.error('操作失败: ' + e.message);
          } finally {
            this.submitting = false;
          }
        },
        // 删除分类：二次确认后调用后端删除并刷新
        async handleDelete(row) {
          try {
            await this.$confirm(`确定要删除分类「${row.name}」吗？如果存在子分类将无法删除。`, '删除确认', { type: 'warning', confirmButtonText: '确定', cancelButtonText: '取消' });
            const headers = this.getAuthHeaders();
            if (!headers) return;
            const resp = await axios.delete(`${apiBaseUrl}/admin/categories/${row.id}`, { headers });
            const result = resp.data;
            if (result.code === 1) {
              this.$message.success('删除成功');
              this.reload();
            } else {
              this.$message.error(result.msg || '删除失败');
            }
          } catch (e) {
            if (e !== 'cancel') {
              console.error('删除失败:', e);
              this.$message.error('删除失败: ' + e.message);
            }
          }
        }
      },
      mounted() { this.loadList(); } // 组件挂载时加载列表
    });
  </script>
</body>
</html>
