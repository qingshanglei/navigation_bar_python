# 用户端和管理端域名绑定方案

为了确保用户端和管理端的安全隔离，我们可以通过以下几种方式使用不同的域名进行绑定：

## 方案一：使用子域名

最常见的做法是为用户端和管理端分配不同的子域名：

1. **用户端**：使用主域名或专用子域名
   - 例如：`www.yoursite.com` 或 `app.yoursite.com`

2. **管理端**：使用专用的管理子域名
   - 例如：`admin.yoursite.com` 或 `manage.yoursite.com`

### 实现步骤：

1. 在DNS服务商处添加两条A记录或CNAME记录：
   ```
   www.yoursite.com    A    服务器IP地址
   admin.yoursite.com  A    服务器IP地址
   ```

2. 在Web服务器(如Nginx、Apache)中配置虚拟主机：

   **Nginx配置示例**：
   ```nginx
   # 用户端配置
   server {
       listen 80;
       server_name www.yoursite.com app.yoursite.com;
       
       location / {
           root /path/to/web;
           try_files $uri $uri/ /index.html;
       }
       
       location /api/ {
           proxy_pass http://localhost:5000;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
       }
   }
   
   # 管理端配置
   server {
       listen 80;
       server_name admin.yoursite.com manage.yoursite.com;
       
       location / {
           root /path/to/admin;
           try_files $uri $uri/ /dashboard.html;
       }
       
       location /api/ {
           proxy_pass http://localhost:5000;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
       }
   }
   ```

   **Apache配置示例**：
   ```apache
   # 用户端配置
   <VirtualHost *:80>
       ServerName www.yoursite.com
       ServerAlias app.yoursite.com
       DocumentRoot /path/to/web
       
       <Directory "/path/to/web">
           AllowOverride All
           Require all granted
       </Directory>
       
       ProxyPass /api/ http://localhost:5000/api/
       ProxyPassReverse /api/ http://localhost:5000/api/
   </VirtualHost>
   
   # 管理端配置
   <VirtualHost *:80>
       ServerName admin.yoursite.com
       ServerAlias manage.yoursite.com
       DocumentRoot /path/to/admin
       
       <Directory "/path/to/admin">
           AllowOverride All
           Require all granted
       </Directory>
       
       ProxyPass /api/ http://localhost:5000/api/
       ProxyPassReverse /api/ http://localhost:5000/api/
   </VirtualHost>
   ```

## 方案二：使用端口区分（本地开发环境）

在本地开发环境中，可以通过不同端口来模拟不同域名：

1. **用户端**：`localhost:8080`
2. **管理端**：`localhost:8081`

### 实现步骤：

修改后端服务配置，使其支持跨域请求，并在前端分别启动两个服务：

```javascript
// 用户端启动命令
npx http-server ./web -p 8080

// 管理端启动命令
npx http-server ./admin -p 8081
```

## 后端配置调整

无论采用哪种方案，后端都需要能够识别请求来源并进行相应的权限控制：

1. 在后端添加域名检查中间件：

```python
@app.before_request
def check_domain():
    host = request.headers.get('Host')
    
    # 管理端API访问控制
    if request.path.startswith('/api/admin/'):
        if not ('admin' in host or 'manage' in host):
            return jsonify({"error": "Unauthorized access"}), 403
            
    # 可以添加更多的访问控制逻辑
```

2. 配置CORS（跨域资源共享）：

```python
from flask_cors import CORS

# 配置允许的域名
allowed_origins = [
    "http://www.yoursite.com", 
    "http://app.yoursite.com",
    "http://admin.yoursite.com", 
    "http://manage.yoursite.com"
]

CORS(app, resources={r"/api/*": {"origins": allowed_origins}})
```

## 安全增强措施

1. **启用HTTPS**：为所有域名配置SSL证书
2. **设置安全Cookie**：添加secure和httpOnly标志
3. **实施CSP**：内容安全策略，防止XSS攻击
4. **添加防火墙规则**：限制管理端的IP访问范围

通过以上配置，可以有效地将用户端和管理端在域名层面进行隔离，提高系统的安全性。

## 虚拟主机部署中区分不同域名的方法

在虚拟主机环境中区分不同域名主要依靠"基于名称的虚拟主机"(Name-based Virtual Hosting)技术。这种技术允许多个域名共享同一个IP地址，但提供不同的内容。下面详细说明如何在常见的虚拟主机环境中实现这一点：

### 1. 共享虚拟主机环境（如cPanel, Plesk等）

在共享虚拟主机环境中，通常有控制面板可以帮助您轻松设置：

#### cPanel环境

1. **添加域名**:
   - 登录cPanel控制面板
   - 找到"域名"或"Domains"部分
   - 点击"添加域名"或"Add Domain"
   - 分别添加用户端域名和管理端域名

2. **设置文档根目录**:
   - 为每个域名指定不同的文档根目录
   - 用户端: `/public_html/web/`
   - 管理端: `/public_html/admin/`

3. **SSL证书配置**:
   - 在"SSL/TLS"部分为每个域名单独安装SSL证书

#### Plesk环境

1. **添加域名**:
   - 登录Plesk控制面板
   - 点击"添加域名"
   - 分别添加用户端和管理端域名

2. **设置文档根目录**:
   - 在域名设置中，为每个域名指定不同的文档根目录
   - 用户端: `/httpdocs/web/`
   - 管理端: `/httpdocs/admin/`

### 2. VPS或独立服务器环境

如果您使用VPS或独立服务器，需要手动配置Web服务器：

#### Apache配置

1. **创建虚拟主机配置文件**:
   
   在`/etc/apache2/sites-available/`目录下创建两个配置文件：

   **用户端配置** (`user-site.conf`):
   ```apache
   <VirtualHost *:80>
       ServerName user.yoursite.com
       DocumentRoot /var/www/html/web
       
       <Directory /var/www/html/web>
           Options Indexes FollowSymLinks
           AllowOverride All
           Require all granted
       </Directory>
       
       ErrorLog ${APACHE_LOG_DIR}/user-error.log
       CustomLog ${APACHE_LOG_DIR}/user-access.log combined
   </VirtualHost>
   ```

   **管理端配置** (`admin-site.conf`):
   ```apache
   <VirtualHost *:80>
       ServerName admin.yoursite.com
       DocumentRoot /var/www/html/admin
       
       <Directory /var/www/html/admin>
           Options Indexes FollowSymLinks
           AllowOverride All
           Require all granted
       </Directory>
       
       ErrorLog ${APACHE_LOG_DIR}/admin-error.log
       CustomLog ${APACHE_LOG_DIR}/admin-access.log combined
   </VirtualHost>
   ```

2. **启用站点**:
   ```bash
   sudo a2ensite user-site.conf
   sudo a2ensite admin-site.conf
   sudo systemctl reload apache2
   ```

#### Nginx配置

1. **创建虚拟主机配置文件**:
   
   在`/etc/nginx/sites-available/`目录下创建两个配置文件：

   **用户端配置** (`user-site`):
   ```nginx
   server {
       listen 80;
       server_name user.yoursite.com;
       root /var/www/html/web;
       index index.html index.htm;
       
       location / {
           try_files $uri $uri/ =404;
       }
       
       location /api/ {
           proxy_pass http://localhost:5000;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
       }
       
       error_log /var/log/nginx/user-error.log;
       access_log /var/log/nginx/user-access.log;
   }
   ```

   **管理端配置** (`admin-site`):
   ```nginx
   server {
       listen 80;
       server_name admin.yoursite.com;
       root /var/www/html/admin;
       index index.html index.htm;
       
       location / {
           try_files $uri $uri/ =404;
       }
       
       location /api/ {
           proxy_pass http://localhost:5000;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
       }
       
       error_log /var/log/nginx/admin-error.log;
       access_log /var/log/nginx/admin-access.log;
   }
   ```

2. **启用站点**:
   ```bash
   sudo ln -s /etc/nginx/sites-available/user-site /etc/nginx/sites-enabled/
   sudo ln -s /etc/nginx/sites-available/admin-site /etc/nginx/sites-enabled/
   sudo nginx -t  # 测试配置
   sudo systemctl reload nginx
   ```

### 3. DNS配置

无论使用哪种虚拟主机环境，都需要在DNS服务商处正确配置域名解析：

1. **添加A记录或CNAME记录**:
   ```
   user.yoursite.com    A    服务器IP地址
   admin.yoursite.com   A    服务器IP地址
   ```

2. **等待DNS生效**:
   - DNS更改通常需要几分钟到48小时不等的传播时间

### 4. 后端配置

确保后端应用能够识别不同的域名请求：

```python
@app.before_request
def check_domain():
    host = request.headers.get('Host')
    
    # 根据域名区分处理逻辑
    if 'admin' in host:
        # 管理端请求处理
        if request.path.startswith('/api/') and not request.path.startswith('/api/admin/'):
            return jsonify({"error": "Unauthorized access"}), 403
    else:
        # 用户端请求处理
        if request.path.startswith('/api/admin/'):
            return jsonify({"error": "Unauthorized access"}), 403
```

### 5. 安全注意事项

1. **为每个域名配置独立的SSL证书**
2. **设置适当的访问控制和权限**
3. **配置安全的Cookie策略**:
   ```
   Set-Cookie: session=...; Domain=admin.yoursite.com; Secure; HttpOnly; SameSite=Strict
   ```
4. **考虑使用子域隔离**:
   - 确保cookie不会在子域间共享
   - 设置正确的`Domain`属性
